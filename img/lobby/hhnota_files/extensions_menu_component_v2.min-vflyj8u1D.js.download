define(["require","exports","tslib","react","external/react-redux","modules/clean/react/css","modules/core/i18n","spectrum/button","spectrum/popover","modules/clean/file_store/utils","modules/clean/react/extensions/file","modules/clean/react/file_viewer/open_button/types","modules/clean/react/app_actions/telemetry_client","modules/clean/react/files_view/constants","spectrum/tertiary_link","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/logging","modules/clean/react/extensions/data/selectors","modules/clean/react/extensions/extensions_utils","modules/clean/react/extensions/data/types","modules/clean/react/extensions/data/action_creators","modules/clean/react/app_actions/shared_file_popover_content_component","modules/clean/integrations/data/selectors","classnames","modules/clean/react/extensions/extensions_popover_content_component_v2","modules/clean/react/extensions/tooltips","modules/clean/react/app_actions/apis","modules/clean/react/app_actions/education/edu_tooltip_component","modules/clean/react/file_viewer_sidebar/buttons/icon","modules/clean/react/file_viewer/unity/with_unity","modules/clean/react/extensions/data/helpers","modules/clean/react/file_viewer/callout_utils","modules/constants/file_viewer"],function(e,t,n,o,i,r,a,s,l,p,c,u,d,g,f,m,_,h,w,v,T,y,C,E,I,O,x,S,B,P,A,F,b){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),o=n.__importDefault(o),E=n.__importDefault(E),b=n.__importStar(b);var D=(function(e){function t(t){var i=e.call(this,t)||this;return i.setActionMenuRef=function(e){i.actionMenuContent=e},i.openOptionsArgs=function(){var e=i.props,t=e.featureFlags,o=e.telemetryContext,r=o?o.surface:void 0,a="ON"===t.cloudEditorsEnabled;return n.__assign({},i.props,{isCloudEditorDisabled:a,surface:r})},i.handleButtonClick=function(e){e.preventDefault(),e.stopPropagation(),i.setPopoverContentPosition(),i.actionMenuContent&&i.actionMenuContent.focus()},i.handleHover=function(){i.currentSession&&i.currentSession.event("trigger_hover")},i.setBigTooltip=function(e){return n.__awaiter(i,void 0,void 0,function(){var t,o,i,r,a,s,l,p,u;return n.__generator(this,function(n){switch(n.label){case 0:return t=this.props,o=t.file,i=t.appActions,r=t.featureFlags,a=c.getFileExt(o)||"",s=i.length>0,s?[4,x.getTooltipHistory(e,["open_with_edu","download_intercept_pdf"])]:[3,2];case 1:l=n.sent(),p=O.allowedTooltipsForConfigV2(s,a,r),u=p.find(function(e){return void 0!==l[e]&&!l[e]}),this.setState({bigTooltipName:u}),n.label=2;case 2:return[2]}})})},i.markBigTooltipViewed=function(){var e=!1,t=[];"download_intercept_pdf"===i.state.bigTooltipName?i.props.inDownloadInterceptFlow&&i.props.setInDownloadInterceptFlow&&(i.props.setInDownloadInterceptFlow({inDownloadInterceptFlow:!1}),e=!0):i.state.bigTooltipName&&(t.push(x.markTooltipViewed(i.props.user.id,i.state.bigTooltipName)),e=!0),e&&(Promise.all(t).then(function(){i.props.showBigTooltip&&i.setBigTooltip(i.props.user.id)}),i.setState({bigTooltipName:void 0}))},i.handleSelectAction=function(e,t){t.preventDefault(),e.handler(),i.logToPreviews(e,!1),t.stopPropagation()},i.logToPreviews=function(e,t){if(i.props.telemetryContext&&"previews"===i.props.telemetryContext.surface&&e.userAction){var n=t?m.UserActionContext.TitleBarMain:m.UserActionContext.TitleBarSplitButton,o=e.actionName?{app_action_name:e.actionName}:{};p.isBrowseFile(i.props.file)&&i.props.file.read_only&&(o.readOnly=!0),_.logUserAction(e.userAction,n,o)}},i.renderTrigger=function(){return i.props.triggerType===v.TriggerType.SidebarLink?o.default.createElement(f.TertiaryLink,{className:"app-action-open-with-menu__trigger app-action-open-with-menu__trigger-link",icon:"open-with"},i.triggerText()):o.default.createElement(s.Button,{className:"app-action-open-with-menu__trigger app-action-open-with-menu__trigger-button",variant:i.props.triggerType===v.TriggerType.SecondaryButton||i.props.triggerType===v.TriggerType.CollapsedButton?"secondary":"primary",tagName:"span"},i.renderTriggerButtonContent())},i.renderMenu=function(e){var t=i.getEduTooltipExperimentConfig(i.state.bigTooltipName);return o.default.createElement("div",{className:E.default("app-action-open-with-menu",{"download-intercept-flow":i.props.inDownloadInterceptFlow}),ref:i.setActionMenuRef},o.default.createElement(l.Popover,{className:"app-action-open-with-menu__popover",onClick:i.handleButtonClick,onDoubleClick:i.handleButtonClick,onSelection:i.handleSelectAction,onMenuToggle:i.onPopoverToggle,closeOnSelection:!0},o.default.createElement(l.PopoverTrigger,null,o.default.createElement("div",{onMouseDown:i.markBigTooltipViewed,onMouseEnter:i.handleHover},i.renderTrigger())),o.default.createElement(l.PopoverContent,{position:i.state.popoverContentPosition,attachment:"right",height:i.state.height},i.renderExtensionPopoverV2Content(e))),t&&!F.isPromptCalloutEnabled()?o.default.createElement(S.ExtensionsTooltip,{userId:i.props.user.id,targetNode:i.actionMenuContent,title:t.tooltipTitle,message:t.tooltipMessage,logHistory:i.markBigTooltipViewed}):null)},i.onPopoverToggle=function(e){var t=e.isOpen;i.props.onDropdownOpen&&i.props.onDropdownClose&&(t?i.props.onDropdownOpen():i.props.onDropdownClose()),i.currentSession&&i.currentSession.event(t?"open_popover":"close_popover")},i.onDownloadClick=function(e){return function(t){t.preventDefault(),t.stopPropagation(),e.handler(),i.logToPreviews(e,!0)}},i.handleUpdateLinkState=function(e,t){var n=i.props.updateLinkState;n&&n({actionId:e,linkState:t})},i.state={popoverContentPosition:"below"},i.telemetryClient=d.createTelemetryClient({component:"menu_v2"}),i}return n.__extends(t,e),t.prototype.componentDidMount=function(){this.props.showBigTooltip&&this.setBigTooltip(this.props.user.id)},t.prototype.setPopoverContentPosition=function(){var e=this.actionMenuContent.getElementsByClassName("app-action-open-with-menu__trigger")[0],t=2*g.OverflowMenuConstants.MENU_MARGIN_PX,n=0,o=this.props,i=o.appActions,r=o.telemetryContext;w.getOpenOptionsForFile(this.openOptionsArgs()).forEach(function(e){e.type===u.OpenButtonAction.OPEN_IN_PAPER?n+=40:e.type===u.OpenButtonAction.OPEN_WITH||e.type===u.OpenButtonAction.OPEN_WITH_CLOUD_DOC?n+=40:e.type!==u.OpenButtonAction.UNITY_FILE&&e.type!==u.OpenButtonAction.UNITY_FOLDER||(n+=40)}),n+=n?t+19:0;var a=A.partitionActions(i),s=a.cloudEditors,l=a.installedActions,p=a.promotedActions;l.concat(p.slice(0,5)).forEach(function(e){n+=52}),s.forEach(function(e){n+=52}),n+=l.length>0?t+19:0,n+=p.length>0?22+t:0,n+=p.length>5?40:0;var c=e.getBoundingClientRect();if(c.top>n+132&&c.bottom+n+60>window.innerHeight)this.setState({popoverContentPosition:"above"});else if(this.setState({popoverContentPosition:"below"}),r&&"sidebar"===r.surface){var d=Math.min(n,window.innerHeight-c.bottom-60);this.setState({height:d})}},t.prototype.triggerText=function(){return this.props.isInFVSidebar||"OPEN"===b.OPEN_WITH_BUTTON_TEXT?a._("Open"):a._("Open with")},t.prototype.renderTriggerButtonContent=function(){var e=this.triggerText();return this.props.triggerType===v.TriggerType.CollapsedButton?o.default.createElement("div",{className:"app-actions-open-with-menu__trigger-content"},o.default.createElement(B.ButtonIcon,{name:"open","aria-label":e})):o.default.createElement("div",{className:"app-actions-open-with-menu__trigger-content app-actions-open-with-menu__trigger-content--with-text"},o.default.createElement("div",{className:"app-action-open-with-menu__trigger-button-text"},e+" â–¾"))},t.prototype.getEduTooltipExperimentConfig=function(e){switch(e){case"open_with_edu":return O.EduTooltipExperiment.TOOLTIP_CONFIGS[e];case"download_intercept_pdf":if(this.props.inDownloadInterceptFlow)return O.EduTooltipExperiment.TOOLTIP_CONFIGS[e];return;default:return}},t.prototype.renderExtensionPopoverV2Content=function(e){var t=this.props,n=t.file,i=t.user,r=t.appActions,a=t.bylines,s=t.categoryInfos,l=t.appIcons,c=t.featureFlags,u=t.refreshAppIcons,d=t.telemetryContext,g=w.getCategoryIdToInfos(s);return p.isBrowseFile(n)&&(r.length>0||e.length>0)?o.default.createElement(I.ExtensionsPopoverV2WithUnity,{file:n,user:i,openOptions:e,appActions:r,bylines:a,categoryIdToInfos:g,appIcons:l,featureFlags:c,refreshAppIcons:u,updateLinkState:this.handleUpdateLinkState,telemetryContext:d,currentSession:this.currentSession}):p.isSharedFile(n)?o.default.createElement(y.SharedFilePopoverContent,{openOptions:e}):null},t.prototype.render=function(){var e=this.props,t=e.file,n=e.appActions,i=e.featureFlags,r=e.isInFVSidebar,l=e.telemetryContext,g=e.triggerType,f=e.showAsButtonIfDownloadOnly;if(!t.file_id)return null;l?this.currentSession=this.telemetryClient.session({surface:l.surface,ext:d.getPiiSafeExtension(c.getFileExt(t)||""),feature_flags:i}):delete this.currentSession;var m=w.getOpenOptionsForFile(this.openOptionsArgs()),_=g===v.TriggerType.CollapsedButton,h=m.length>0,T=!1;if(h&&1===m.length&&(T=m[0].type===u.OpenButtonAction.DOWNLOAD,h=!T),h||0!==n.length&&!p.isSharedFile(t))return this.renderMenu(m);if(f&&T){var y=g===v.TriggerType.SecondaryButton||_?"secondary":"primary",C=_||r&&"secondary"===y;return o.default.createElement(s.Button,{className:E.default("app-actions-download-button",{"app-actions-download-button--collapsed":C}),variant:y,onClick:this.onDownloadClick(m[0])},C?o.default.createElement(B.ButtonIcon,{name:"download-file",isPrimary:"primary"===y,"aria-label":a._("Download")}):a._("Download"))}return null},t.defaultProps={showAsButtonIfDownloadOnly:!1,triggerType:v.TriggerType.SecondaryButton},t})(o.default.Component);t.ExtensionsMenuV2Component=D;var N=function(e){return p.isBrowseFile(e.file)?o.default.createElement(P.WithUnity,{file:e.file,user:e.user,render:function(t){return o.default.createElement(D,n.__assign({},e,{unityInfo:t}))}}):o.default.createElement(D,n.__assign({},e))},k=function(e,t){return{appActions:h.getActionsForFile(e,t.file),bylines:h.getBylines(e),categoryInfos:h.getCategoryInfos(e),appIcons:h.getAppIcons(e),featureFlags:h.getFeatureFlags(e),cloudDocsInfo:h.getCloudDocInfo(e),inDownloadInterceptFlow:h.inDownloadInterceptFlow(e),landingPagesEnabled:C.isConnectServiceLandingPagesEnabled(e)}},M={refreshAppIcons:T.refreshAppIcons,updateLinkState:T.updateLinkState,refreshSharingServiceInfo:T.refreshSharingServiceInfoAdapter,setInDownloadInterceptFlow:T.setInDownloadInterceptFlow},L=i.connect(k,M)(N);t.ExtensionsMenuV2=r.requireCssWithComponent(L,["/static/css/app_actions/index-vflP_P0Ft.css"])});
//# sourceMappingURL=extensions_menu_component_v2.min.js-vflVFCW_j.map