define(["require","exports","tslib","react","modules/clean/filepath","modules/core/uri","modules/core/i18n","modules/clean/react/css","spectrum/popover","modules/clean/static_urls","modules/clean/react/file_viewer/open_button/types","modules/clean/react/app_actions/category","modules/clean/react/app_actions/redirect","modules/clean/react/sprite","spectrum/icon_action","spectrum/icon_document","modules/clean/react/file_viewer/unity/with_unity","modules/clean/react/file_viewer/constants","modules/clean/react/app_actions/byline","modules/clean/react/app_actions/redirect","modules/clean/react/extensions/auth_modal","modules/clean/react/modal","modules/clean/react/app_actions/redirect"],function(e,t,a,n,o,i,r,s,c,l,p,u,d,m,_,f,y,h,g,E,N,v,w){"use strict";function I(e){return void 0!==e.openOptionName}function A(e,t,n,o,i){return a.__awaiter(this,void 0,Promise,function(){var r,s;return a.__generator(this,function(a){switch(a.label){case 0:return r=function(){return o.then(function(e){return{redirect_url:i(e).toString()}})},[4,E.showLoadingPageAndDoRedirect(t,void 0,e,n.file_id,r,"width=800,height=600")];case 1:return s=a.sent(),[2,void 0!==s]}})})}function O(t,n){return a.__awaiter(this,void 0,Promise,function(){var o,i,r,s,c,l,p;return a.__generator(this,function(u){switch(u.label){case 0:return[4,new Promise(function(t,a){e(["modules/clean/api_v2/user_client"],t,a)}).then(a.__importStar)];case 1:o=u.sent().UserApiV2Client,i=new o,r={path:n.file_id},u.label=2;case 2:return u.trys.push([2,4,,5]),s={path:n.file_id,settings:{requested_visibility:{".tag":"public"}}},[4,i.ns("sharing").rpc("alpha/create_shared_link_with_settings",s,{subjectUserId:t.id})];case 3:return c=u.sent(),[2,c.url];case 4:if(l=u.sent(),!l.error||"shared_link_already_exists"!==l.error[".tag"])throw l;return[3,5];case 5:return[4,i.ns("sharing").rpc("list_shared_links",r,{subjectUserId:t.id})];case 6:if(p=u.sent(),0===p.links.length)throw new Error("Expected get result to contain at least one entry");return[2,p.links[0].url]}})})}function C(e,t){var a=o.filename(t.ns_path),n=O(e,t).then(function(e){return{subject:r._("%(file_name)s - Shared with Dropbox").format({file_name:a}),body:e}});return A(r._("Gmail"),e,t,n,P)}Object.defineProperty(t,"__esModule",{value:!0}),n=a.__importDefault(n),o=a.__importStar(o);var x=[{entries:[{openOptionName:"unity"}]},{displayName:r._("Edit"),entries:[{openOptionName:"openWith"},{categoryId:u.Category.OPEN_WITH_CLOUD_DOC}]},{displayName:r._("Edit"),entries:[{categoryId:u.Category.PDF_EDITING}]},{displayName:r._("Edit"),entries:[{categoryId:u.Category.IMAGE_EDITING}]},{displayName:u.Category.getDisplayName(u.Category.VIDEO_EDITING),entries:[{categoryId:u.Category.VIDEO_EDITING}]},{displayName:r._("Copy to"),entries:[{openOptionName:"copyTo"}]},{displayName:u.Category.getDisplayName(u.Category.VIDEO_COMMENT),entries:[{categoryId:u.Category.VIDEO_COMMENT}]},{displayName:u.Category.getDisplayName(u.Category.VIEW_OR_EDIT),entries:[{categoryId:u.Category.VIEW_OR_EDIT}]},{displayName:u.Category.getDisplayName(u.Category.SEND_WITH),entries:[{openOptionName:"email"},{openOptionName:"share"},{categoryId:u.Category.SEND_WITH}]},{displayName:r._("Present"),entries:[{openOptionName:"present"}]},{displayName:u.Category.getDisplayName(u.Category.ESIGNATURE),entries:[{openOptionName:"esignature"},{categoryId:u.Category.ESIGNATURE}]},{displayName:u.Category.getDisplayName(u.Category.SEND_FAX),entries:[{categoryId:u.Category.SEND_FAX}]},{displayName:r._("Download"),entries:[{openOptionName:"download"}]},{displayName:r._("TESTING"),entries:[{categoryId:u.Category.DEFAULT}]}],D=(function(e){function t(t){var i=e.call(this,t)||this;return i.handleSentViaGmail=function(){return a.__awaiter(i,void 0,void 0,function(){var e,t,n,o;return a.__generator(this,function(a){switch(a.label){case 0:return e=this.props,t=e.user,n=e.file,this.logEvent("select_gmail_action",{}),[4,C(t,n)];case 1:return o=a.sent(),o?this.logEvent("select_gmail_action_success",{}):this.logEvent("select_gmail_action_failure",{}),[2]}})})},i.renderCategory=function(e){return n.default.createElement(c.PopoverItemGroup,{className:"app-action-category-group",key:e.key},e.displayName?n.default.createElement(c.PopoverItemGroupTitle,{className:"app-action-category-title"},e.displayName):null,e.actions.map(function(e){return i.renderActionRow(e)}),n.default.createElement(c.PopoverItemGroupSeparator,{className:"app-action-menu-separator"}))},i.createAppActionClickHandler=function(e){return function(){var t=i.props,a=t.file,n=t.user,r=t.extensionsConfig;if("redirect"!==e.handler[".tag"])throw new Error('Unexpected handler "'+e.handler[".tag"]+'"');var s=e.handler.window_params,c=void 0;if("popup"===s[".tag"]){c="width="+s.width+",height="+s.height}if("ON"!==r.featureFlags.expSFADialog||"sfa_unlinked"!==e.link_state[".tag"]||e.id.startsWith("fp_action_id:"))d.redirectToAction(n,e.id,e.description,a.file_id,c);else{var l=o.filename(a.ns_path);i.showAuthModalV2(n,e.id,e.description,e.icon.url,a.file_id,l,c)}i.logEvent("select_action",{action_id:e.id,encoded_app_id:e.app_id})}},i.doAuthForAction=function(e,t,n,o,r){return function(){return a.__awaiter(i,void 0,void 0,function(){var i;return a.__generator(this,function(a){switch(a.label){case 0:return v.Modal.close(),[4,w.authAction(e,t,n,o,r)];case 1:return i=a.sent(),this.props.updateLinkState&&i&&i.link_state&&this.props.updateLinkState(t,i.link_state),[2]}})})}},i.showAuthModalV2=function(e,t,a,o,r,s,c){v.Modal.showInstance(n.default.createElement(N.AuthModal,{actionId:t,appName:a,iconUrl:o,fileId:r,fileName:s,doAuth:i.doAuthForAction(e,t,a,r,c),doCancel:v.Modal.close}))},i.wrapperForAction=function(e,t,a){return{handler:i.createAppActionClickHandler(e),userAction:h.UserAction.OpenWithAppAction,actionName:e.description}},i.handleImgLoadError=function(){i.props.refreshAppIcons&&i.props.refreshAppIcons({user:i.props.user})},i.renderActionRow=function(e){if(!i.isApiAppAction(e))return e;var t=e.icon;e.app_id&&(t=i.props.appIcons[e.app_id]||t);var a=t.is_static?l.static_url("/static/images/generic_app_icon-vflIPYT1H.png"):t.url,o=e.link_state[".tag"].indexOf("_linked")>=0,r=n.default.createElement(c.PopoverContentItem,{className:"app-action-row",key:e.id,value:i.wrapperForAction(e,a,o)},n.default.createElement("div",null,n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement("img",{className:"app-action-popover-icon",src:a,alt:"",onError:i.handleImgLoadError}),n.default.createElement("div",{className:"app-action-popover-item-info"},e.description))));return n.default.createElement(g.ExtensionsBylineTooltip,{bylines:e.app_id?i.props.extensionsConfig.bylines[e.app_id]:void 0,onDidShow:i.handleShowByline(e.app_id)},r)},i.state={popoverContentPosition:"below",showTooltip:void 0},i}return a.__extends(t,e),t.prototype.includeDownloadInMenu=function(){return this.props.showAsButtonIfDownloadOnly},t.prototype.logEvent=function(e,t){this.props.currentSession&&this.props.currentSession.event(e,t)},t.prototype.getOpenOptionsWithLogging=function(e){var t=this;return e.map(function(e){return a.__assign({},e,{handler:function(){e.handler(),t.logEvent("select_legacy_action",{type:e.type})}})})},t.prototype.handleShowByline=function(e){var t=this;return function(){t.logEvent("show_byline",{extension_id:e})}},t.prototype.renderOpenOptions=function(e){var t=this,a=this.props.extensionsConfig.bylines,o=this.getOpenOptionsWithLogging(e),i=[],s=[],u=[],d=[],y=[],h=[],E=[],N=[];if(o.forEach(function(e){var o=e.type,N=o===p.OpenButtonAction.OPEN_IN_PAPER,v=o===p.OpenButtonAction.OPEN_WITH,w=o===p.OpenButtonAction.UNITY_FILE||o===p.OpenButtonAction.UNITY_FOLDER,I=o===p.OpenButtonAction.DOWNLOAD,A=o===p.OpenButtonAction.PREPARE_FOR_SIGNATURE,O=o===p.OpenButtonAction.SHARE_TO_SLACK,C=o===p.OpenButtonAction.PRESENT_IN_ZOOM;if(o===p.OpenButtonAction.OPEN_WITH_CLOUD_DOC)s.push(n.default.createElement(g.ExtensionsBylineTooltip,{bylines:a.cloud_doc,onDidShow:t.handleShowByline("cloud_doc")},n.default.createElement(c.PopoverContentItem,{key:e.text,value:e,className:"app-action-row"},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement("img",{alt:e.text,src:e.iconUrl,className:"app-action-popover-icon"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},e.text)))));else if(N&&e.spriteName)i.push(n.default.createElement(g.ExtensionsBylineTooltip,{bylines:a.paper,onDidShow:t.handleShowByline("paper")},n.default.createElement(c.PopoverContentItem,{className:"app-action-row",key:e.text,value:e},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement("img",{alt:"",src:l.static_url("/static/images/paper/paper-icon-vfluG3iA1.png"),className:"app-action-popover-icon"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},r._("Paper"))))));else if((w||v)&&e.spriteName){var x=w?u:s,D=w?"unity":"wopi";x.push(n.default.createElement(g.ExtensionsBylineTooltip,{bylines:a[D],onDidShow:t.handleShowByline(D)},n.default.createElement(c.PopoverContentItem,{key:e.text,value:e,className:"app-action-row"},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement(m.Sprite,{group:"web",name:e.spriteName,alt:e.text,className:"app-action-popover-icon-sprite"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},e.text)))))}else I&&t.includeDownloadInMenu()?d.push(n.default.createElement(c.PopoverContentItem,{key:e.text,value:e,className:"app-action-row"},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement(_.IconAction,{className:"app-action-popover-icon-svg",name:"download"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},e.text)))):O?h.push(n.default.createElement(c.PopoverContentItem,{key:e.text,value:e,className:"app-action-row"},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement("img",{alt:r._("Share to Slack"),src:l.static_url("/static/images/thirdparty/slack_icon-vflKvKltK.svg"),className:"app-action-popover-icon"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},e.text)))):C?E.push(n.default.createElement(c.PopoverContentItem,{key:e.text,value:e,className:"app-action-row"},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement("img",{alt:r._("Zoom"),src:l.static_url("/static/images/thirdparty/zoom_squircle-vflImll5V.svg"),className:"app-action-popover-icon"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},e.text)))):A&&y.push(n.default.createElement(c.PopoverContentItem,{key:e.text,value:e,className:"app-action-row"},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement(f.IconDocument,{className:"app-action-popover-icon-svg",name:"signature-small"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},e.text))))}),!this.props.firstPartyActionIds.includes("fp_action_id:gmail")&&"ON"===this.props.extensionsConfig.featureFlags.expGmailAction){var v={name:"gmail",handler:this.handleSentViaGmail};N.push(n.default.createElement(c.PopoverContentItem,{key:"gmail",value:v,className:"app-action-row"},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement("img",{alt:"",src:l.static_url("/static/images/thirdparty/gmail_icon-vflugrKbt.png"),className:"app-action-popover-icon"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},r._("Gmail")))))}return{copyTo:i,openWith:s,unity:u,download:d,share:h,present:E,esignature:y,email:N}},t.prototype.renderActions=function(e){var t={};this.props.extensionsConfig.actionCategories.map(function(e){t[e.categoryId]=e});var a=[];x.map(function(n,o){for(var i=[],r=0,s=n.entries;r<s.length;r++){var c=s[r];I(c)?i.push.apply(i,e[c.openOptionName]):t[c.categoryId]&&i.push.apply(i,t[c.categoryId].actions)}i.length>0&&a.push({displayName:n.displayName,key:"category-"+o,actions:i})});var o=a.map(this.renderCategory);return n.default.createElement("div",null,o)},t.prototype.isApiAppAction=function(e){return void 0!==e.id},t.prototype.render=function(){var e=this.props.openOptions,t=this.renderOpenOptions(e);return this.renderActions(t)},t.defaultProps={showAsButtonIfDownloadOnly:!1,unityInfo:{},firstPartyActionIds:[]},t})(n.default.Component),P=function(e){return new i.URI({scheme:"https",authority:"mail.google.com",path:"/mail/",query:{view:"cm",fs:"1",su:e.subject,body:e.body}})};t.ExtensionsPopoverContentWithUnity=function(e){return n.default.createElement(y.WithUnity,{file:e.file,user:e.user,render:function(t){return n.default.createElement(D,a.__assign({},e,{unityInfo:t}))}})},t.ExtensionsPopoverContentNoUnity=s.requireCssWithComponent(D,["/static/css/app_actions/index-vflP_P0Ft.css"])});
//# sourceMappingURL=extensions_popover_content_component.min.js-vfllwyTJ8.map