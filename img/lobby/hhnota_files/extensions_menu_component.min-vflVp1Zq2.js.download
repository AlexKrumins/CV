define(["require","exports","tslib","react","external/react-redux","modules/clean/react/css","modules/core/i18n","spectrum/button","spectrum/popover","modules/clean/react/file_viewer/open_button/utils","modules/clean/file_store/utils","modules/clean/react/extensions/file","modules/clean/react/file_viewer/open_button/types","modules/clean/react/app_actions/telemetry_client","modules/clean/react/files_view/constants","spectrum/tertiary_link","modules/clean/react/file_viewer/unity/with_unity","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/logging","modules/clean/react/app_actions/education/edu_tooltip_component","modules/clean/react/app_actions/apis","modules/clean/react/extensions/data/selectors","modules/clean/react/extensions/data/types","modules/clean/react/extensions/extensions_popover_content_component","modules/clean/react/extensions/data/action_creators","modules/clean/react/extensions/utils","modules/clean/cloud_docs/open_with_utils","modules/clean/cloud_docs/event_logging","modules/clean/react/extensions/tooltips","modules/clean/react/app_actions/shared_file_popover_content_component","modules/clean/integrations/data/selectors","classnames","modules/clean/react/file_viewer_sidebar/buttons/icon","modules/clean/react/file_viewer/callout_utils","modules/constants/file_viewer"],function(e,t,n,o,i,r,s,a,p,l,c,u,d,h,f,g,m,_,w,v,I,y,S,C,T,E,O,x,D,P,B,b,A,F,N){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),o=n.__importDefault(o),b=n.__importDefault(b),N=n.__importStar(N);var M=(function(t){function i(e){var i=t.call(this,e)||this;return i.setActionMenuRef=function(e){i.actionMenuContent=e},i.handleButtonClick=function(e){e.preventDefault(),e.stopPropagation(),i.setPopoverContentPosition()},i.handleHover=function(){i.currentSession&&i.currentSession.event("trigger_hover")},i.setBigTooltip=function(e){return n.__awaiter(i,void 0,void 0,function(){var t,o,i,r;return n.__generator(this,function(n){switch(n.label){case 0:return t=this.props.extensionsConfig.actionCategories.length>0,t||"CONTROL"===this.props.featureFlags.expSplitShareBtn?[4,I.getTooltipHistory(e,["open_with_edu","download_intercept_pdf"])]:[3,2];case 1:o=n.sent(),i=D.allowedTooltipsForConfig(this.props.extensionsConfig,u.getFileExt(this.props.file)||""),r=i.find(function(e){return void 0!==o[e]&&!o[e]}),this.setState({bigTooltipName:r}),n.label=2;case 2:return[2]}})})},i.markBigTooltipViewed=function(){var e=!1,t=[];return"download_intercept_pdf"===i.state.bigTooltipName?i.props.inDownloadInterceptFlow&&i.props.setInDownloadInterceptFlow&&(i.props.setInDownloadInterceptFlow({inDownloadInterceptFlow:!1}),e=!0):i.state.bigTooltipName&&(t.push(I.markTooltipViewed(i.props.user.id,i.state.bigTooltipName)),e=!0),e&&(Promise.all(t).then(function(){i.props.showBigTooltip&&i.setBigTooltip(i.props.user.id)}),i.setState({bigTooltipName:void 0})),e},i.handleSelectAction=function(e,t){t.preventDefault(),e.handler(),i.logToPreviews(e,!1),t.stopPropagation(),e.userAction===_.UserAction.Download&&i.maybeShowDownloadIntercept()},i.logToPreviews=function(e,t){if(i.props.telemetryContext&&"previews"===i.props.telemetryContext.surface&&e.userAction){var n=t?_.UserActionContext.TitleBarMain:_.UserActionContext.TitleBarSplitButton,o=e.actionName?{app_action_name:e.actionName}:{};c.isBrowseFile(i.props.file)&&i.props.file.read_only&&(o.readOnly=!0),w.logUserAction(e.userAction,n,o)}},i.renderTrigger=function(){return i.props.triggerType===S.TriggerType.SidebarLink?o.default.createElement(g.TertiaryLink,{className:"app-action-open-with-menu__trigger app-action-open-with-menu__trigger-link",icon:"open-with"},i.triggerText()):o.default.createElement(a.Button,{className:"app-action-open-with-menu__trigger app-action-open-with-menu__trigger-button",variant:i.props.triggerType===S.TriggerType.SecondaryButton||i.props.triggerType===S.TriggerType.CollapsedButton?"secondary":"primary",tagName:"span"},i.renderTriggerButtonContent())},i.renderMenu=function(e){var t=i.getEduTooltipExperimentConfig(i.state.bigTooltipName);return o.default.createElement("div",{className:b.default("app-action-open-with-menu",{"download-intercept-flow":i.props.inDownloadInterceptFlow}),ref:i.setActionMenuRef},o.default.createElement(p.Popover,{className:"app-action-open-with-menu__popover",onClick:i.handleButtonClick,onDoubleClick:i.handleButtonClick,onSelection:i.handleSelectAction,onMenuToggle:i.onPopoverToggle,closeOnSelection:!0},o.default.createElement(p.PopoverTrigger,null,o.default.createElement("div",{onMouseDown:i.markBigTooltipViewed,onMouseEnter:i.handleHover},i.renderTrigger())),o.default.createElement(p.PopoverContent,{position:i.state.popoverContentPosition,attachment:"right",height:i.state.height},i.renderExtensionPopoverContent(e))),t&&!F.isPromptCalloutEnabled()?o.default.createElement(v.ExtensionsTooltip,{userId:i.props.user.id,targetNode:i.actionMenuContent,title:t.tooltipTitle,message:t.tooltipMessage,logHistory:i.markBigTooltipViewed}):null)},i.onPopoverToggle=function(e){var t=e.isOpen;i.props.onDropdownOpen&&i.props.onDropdownClose&&(t?i.props.onDropdownOpen():i.props.onDropdownClose()),i.currentSession&&i.currentSession.event(t?"open_popover":"close_popover")},i.onDownloadClick=function(e){return function(t){t.preventDefault(),t.stopPropagation(),e.handler(),i.logToPreviews(e,!0)}},i.handleUpdateLinkState=function(e,t){var n=i.props.updateLinkState;n&&n({actionId:e,linkState:t})},i.state={popoverContentPosition:"below"},i.telemetryClient=h.createTelemetryClient({component:"menu"}),i}return n.__extends(i,t),i.prototype.componentDidMount=function(){this.props.showBigTooltip&&this.setBigTooltip(this.props.user.id)},i.prototype.includeDownloadInMenu=function(){return this.props.showAsButtonIfDownloadOnly},i.prototype.setPopoverContentPosition=function(){var e=this,t=this.actionMenuContent.getElementsByClassName("app-action-open-with-menu__trigger")[0],n=2*f.OverflowMenuConstants.MENU_MARGIN_PX,o=0,i=0,r=0,s=0,a=0,p=this.props,c=p.extensionsConfig,u=p.file,h=p.onPresentInZoom,g=p.refreshSharingServiceInfo,m=p.sharingServiceInfo,_=p.landingPagesEnabled;l.getOpenOptions({file:u,hasOpenInPaperSupport:!!this.props.hasOpenInPaperSupport,isOpenWithDisabled:!!this.props.isOpenWithDisabled,unityInfo:this.props.unityInfo,extraOptions:this.props.extraOptions,user:this.props.user,sharingServiceInfo:m,refreshSharingServiceInfo:g,showOpenWithShare:E.shouldShowOpenWithShare(c.featureFlags,c.sharingServiceInfo,u),onPresentInZoom:h,isCloudBasedDoc:O.isCloudBasedDoc(u),isCloudEditorDisabled:!c.cloudDocsInfo.openWithGddSupported,landingPagesEnabled:_}).forEach(function(t){t.type===d.OpenButtonAction.OPEN_IN_PAPER?o=n+32:t.type===d.OpenButtonAction.OPEN_WITH||t.type===d.OpenButtonAction.OPEN_WITH_CLOUD_DOC?i=n+32:t.type===d.OpenButtonAction.UNITY_FILE||t.type===d.OpenButtonAction.UNITY_FOLDER?r=n:t.type===d.OpenButtonAction.DOWNLOAD&&e.includeDownloadInMenu()&&(s=n),(e.includeDownloadInMenu()||t.type!==d.OpenButtonAction.DOWNLOAD)&&(a+=40)}),a+=o+i+r+s,this.props.extensionsConfig.actionCategories.forEach(function(e){a+=40*e.actions.length+n+32});var w=t.getBoundingClientRect();if(w.top>a+132&&w.bottom+a+60>window.innerHeight)this.setState({popoverContentPosition:"above"});else if(this.setState({popoverContentPosition:"below"}),this.props.telemetryContext&&"sidebar"===this.props.telemetryContext.surface){var v=Math.min(a,window.innerHeight-w.bottom-60);this.setState({height:v})}},i.prototype.maybeShowDownloadIntercept=function(){return n.__awaiter(this,void 0,void 0,function(){var t,o,i;return n.__generator(this,function(r){switch(r.label){case 0:return[4,new Promise(function(t,n){e(["modules/clean/react/extensions/download_intercept"],t,n)}).then(n.__importStar)];case 1:return t=r.sent().onDownloadFile,o=u.getFileExt(this.props.file),i=this.props.setInDownloadInterceptFlow,o&&i&&t(this.props.extensionsConfig,this.props.user,o,function(){i({inDownloadInterceptFlow:!0})}),[2]}})})},i.prototype.triggerText=function(){return this.props.isInFVSidebar||"OPEN"===N.OPEN_WITH_BUTTON_TEXT?s._("Open"):s._("Open with")},i.prototype.renderTriggerButtonContent=function(){var e=this.triggerText();return this.props.triggerType===S.TriggerType.CollapsedButton?o.default.createElement("div",{className:"app-actions-open-with-menu__trigger-content"},o.default.createElement(A.ButtonIcon,{name:"open","aria-label":e})):o.default.createElement("div",{className:"app-actions-open-with-menu__trigger-content app-actions-open-with-menu__trigger-content--with-text"},o.default.createElement("div",{className:"app-action-open-with-menu__trigger-button-text"},e+" â–¾"))},i.prototype.getEduTooltipExperimentConfig=function(e){switch(e){case"open_with_edu":var t=this.props.featureFlags&&this.props.featureFlags.expSplitShareBtn;return t&&D.EduTooltipExperiment.EDU_SPLIT_SHARE_MAP[t]?D.EduTooltipExperiment.EDU_SPLIT_SHARE_MAP[t]:D.EduTooltipExperiment.TOOLTIP_CONFIGS[e];case"download_intercept_pdf":if(this.props.inDownloadInterceptFlow)return D.EduTooltipExperiment.TOOLTIP_CONFIGS[e];return;default:return}},i.prototype.renderExtensionPopoverContent=function(e){return c.isBrowseFile(this.props.file)&&this.props.extensionsConfig?o.default.createElement(C.ExtensionsPopoverContentWithUnity,{file:this.props.file,extensionsConfig:this.props.extensionsConfig,user:this.props.user,openOptions:e,showAsButtonIfDownloadOnly:this.props.showAsButtonIfDownloadOnly,appIcons:this.props.appIcons,refreshAppIcons:this.props.refreshAppIcons,updateLinkState:this.handleUpdateLinkState,currentSession:this.currentSession,firstPartyActionIds:this.props.firstPartyActionIds}):c.isSharedFile(this.props.file)?o.default.createElement(P.SharedFilePopoverContent,{openOptions:e}):null},i.prototype.render=function(){var e=this.props,t=e.file,n=e.extensionsConfig,i=e.onPresentInZoom,r=e.refreshSharingServiceInfo,p=e.sharingServiceInfo,f=e.landingPagesEnabled,g=e.isInFVSidebar;if(!t.file_id)return null;this.props.telemetryContext?this.currentSession=this.telemetryClient.session({surface:this.props.telemetryContext.surface,ext:h.getPiiSafeExtension(u.getFileExt(t)||""),feature_flags:this.props.featureFlags}):delete this.currentSession;var m=x.getActionSourceFromSurface(this.props.telemetryContext&&this.props.telemetryContext.surface),_=l.getOpenOptions({file:t,hasOpenInPaperSupport:!!this.props.hasOpenInPaperSupport,isOpenWithDisabled:!!this.props.isOpenWithDisabled,unityInfo:this.props.unityInfo,extraOptions:this.props.extraOptions,user:this.props.user,sharingServiceInfo:p,refreshSharingServiceInfo:r,showOpenWithShare:E.shouldShowOpenWithShare(n.featureFlags,n.sharingServiceInfo,t),onPresentInZoom:i,isCloudBasedDoc:O.isCloudBasedDoc(t),actionSource:m,isCloudEditorDisabled:!n.cloudDocsInfo.openWithGddSupported,landingPagesEnabled:f}),w=this.props.triggerType===S.TriggerType.CollapsedButton,v=_.length>0,I=!1;if(v&&1===_.length&&(I=_[0].type===d.OpenButtonAction.DOWNLOAD,v=!I),v||0!==n.actionCategories.length&&!c.isSharedFile(this.props.file))return this.renderMenu(_);if(this.props.showAsButtonIfDownloadOnly&&I){var y=this.props.triggerType===S.TriggerType.SecondaryButton||w?"secondary":"primary",C=w||g&&"secondary"===y;return o.default.createElement(a.Button,{className:b.default("app-actions-download-button",{"app-actions-download-button--collapsed":C}),variant:y,onClick:this.onDownloadClick(_[0])},C?o.default.createElement(A.ButtonIcon,{name:"download-file",isPrimary:"primary"===y,"aria-label":s._("Download")}):s._("Download"))}return null},i.defaultProps={hasOpenInPaperSupport:!1,isOpenWithDisabled:!1,showAsButtonIfDownloadOnly:!1,triggerType:S.TriggerType.SecondaryButton,unityInfo:Object.freeze({local_path:null,resolved_local_path:null,is_locally_available:!1,can_open_directly:!1,open_application_identifier:null,open_application_name:null,path_is_dir:!1,is_infinite_placeholder:!1,error_message:null})},i})(o.default.Component);t.ExtensionsMenuComponent=M,t.ExtensionsMenuWithUnityComponent=function(e){return c.isBrowseFile(e.file)?o.default.createElement(m.WithUnity,{file:e.file,user:e.user,render:function(t){return o.default.createElement(M,n.__assign({},e,{unityInfo:t}))}}):null};var k=function(e,t){return{extensionsConfig:y.getConfigForFile(e,t.file),appIcons:y.getAppIcons(e),featureFlags:y.getFeatureFlags(e),sharingServiceInfo:y.getSharingServiceInfoAdapter(e),inDownloadInterceptFlow:y.inDownloadInterceptFlow(e),landingPagesEnabled:B.isConnectServiceLandingPagesEnabled(e),firstPartyActionIds:y.getFirstPartyActionIds(e,t.file)}},W={refreshAppIcons:T.refreshAppIcons,updateLinkState:T.updateLinkState,refreshSharingServiceInfo:T.refreshSharingServiceInfoAdapter,setInDownloadInterceptFlow:T.setInDownloadInterceptFlow},L=i.connect(k,W)(t.ExtensionsMenuWithUnityComponent),U=i.connect(k,W)(M);t.ExtensionsMenuNoUnity=r.requireCssWithComponent(U,["/static/css/app_actions/index-vflP_P0Ft.css"]),t.ExtensionsMenu=r.requireCssWithComponent(L,["/static/css/app_actions/index-vflP_P0Ft.css"])});
//# sourceMappingURL=extensions_menu_component.min.js-vflkyKwrD.map